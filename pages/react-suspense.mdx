# ЁЯзС React Suspense ржХрж┐, ржХрзЗржи ржЖрж╕рж▓рзЛ (ржмрж┐рж╕рзНрждрж╛рж░рж┐ржд)

ржзрж░рзБржи, ржЖржкржирж┐ ржПржХржЬржи React ржбрзЗржнрзЗрж▓ржкрж╛рж░ред ржЗржЙржЬрж╛рж░ ржЗржирзНржЯрж╛рж░ржлрзЗрж╕ ржмрж╛ржирж╛ржЪрзНржЫрзЗржи ржЖрж░ ржЖржкржирж╛рж░ ржжрж░ржХрж╛рж░тАФржХрзЛржирзЛ ржПржХржЯрж╛ ржХржорзНржкрзЛржирзЗржирзНржЯ рждржЦржиржЗ ржжрзЗржЦрж╛ржирзЛ рж╣ржмрзЗ, ржпржЦржи ржбрзЗржЯрж╛ рж░рзЗржбрж┐ рж╣ржмрзЗред

ржПржЗрж░ржХржо рж╕ржорзЯрзЗ, ржЖржЧрзЗрж░ ржорждрзЛ `useState` ржЖрж░ `useEffect` ржжрж┐рзЯрзЗ рж▓рзЛржбрж┐ржВ ржорзНржпрж╛ржирзЗржЬ ржХрж░рж╛ ржпрж╛рзЯ ржарж┐ржХржЗтАФbut ржЭрж╛ржорзЗрж▓рж╛ рж╣рзЯ ржпржЦржи ржЕржирзЗржХржЧрзБрж▓рзЛ ржЬрж╛рзЯржЧрж╛рзЯ ржПржХрж╕рж╛ржерзЗ рж▓рзЛржбрж┐ржВ/ржПрж░рж░ рж╣рзНржпрж╛ржирзНржбрзЗрж▓ ржХрж░рждрзЗ рж╣рзЯред

React Suspense ржЖрж╕ржЫрзЗ ржПржЗ рж╕ржорж╕рзНржпрж╛рж░ рж╕ржорж╛ржзрж╛ржирзЗред

---

## ЁЯФН Suspense ржХрж┐?

`<Suspense>` ржЖрж╕рж▓рзЗ ржПржХржЯрж╛ React ржХржорзНржкрзЛржирзЗржирзНржЯ, ржпрзЗржЯрж╛ ржЕржирзНржп ржХрзЛржирзЛ ржХржорзНржкрзЛржирзЗржирзНржЯржХрзЗ **тАЬржзрж░рзЗтАЭ рж░рж╛ржЦрзЗ** ржпрждржХрзНрж╖ржг ржирж╛ рж╕рзЗржЯрж╛ ржкрзБрж░рзЛ рж░рзЗржирзНржбрж╛рж░ ржХрж░рж╛рж░ ржЬржирзНржп ржкрзНрж░рж╕рзНрждрзБрждред

ЁЯУж рж╕рж╣ржЬ ржнрж╛рж╖рж╛рзЯ:

```jsx
<Suspense fallback={<Loading />}>
  <Albums />
</Suspense>
```

ржПржЗ ржХрзЛржбрзЗ, ржпржжрж┐ `Albums` ржХржорзНржкрзЛржирзЗржирзНржЯрзЗрж░ ржнрзЗрждрж░рзЗ ржбрзЗржЯрж╛ ржлрзЗржЪ ржХрж░рждрзЗ ржЧрж┐рзЯрзЗ "рж╕ржорзЯ рж▓рж╛ржЧрзЗ", рждржЦржи Suspense `Loading` ржжрзЗржЦрж╛ржмрзЗред

---

## ЁЯдФ Suspense ржХрж┐ржнрж╛ржмрзЗ ржХрж╛ржЬ ржХрж░рзЗ?

ржзрж░рзЗржи ржПржХржЯрж╛ ржХржорзНржкрзЛржирзЗржирзНржЯ рж░рзЗржирзНржбрж╛рж░ рж╣ржЪрзНржЫрзЗ, рж╣ржарж╛рзО рждрж╛рж░ ржоржзрзНржпрзЗ ржбрзЗржЯрж╛ ржжрж░ржХрж╛рж░ ржкрзЬрж▓рзЛ, ржЖрж░ рж╕рзЗржЗ ржбрзЗржЯрж╛ ржЖрж╕рж╛ ржкрж░рзНржпржирзНржд ржЕржкрзЗржХрзНрж╖рж╛ ржХрж░рждрзЗ рж╣ржмрзЗред

рждржЦржи ржХрзА рж╣рзЯ?

1. ржкрзНрж░ржержоржд ржР ржХржорзНржкрзЛржирзЗржирзНржЯржЯрж┐ ржорзВрж▓ JSX Return ржХрж░ржмрзЗ ржирж╛, ржПржХржЯрж╛ **Promise ржерзНрж░рзЛ ржХрж░рзЗ**ред
2. React ржжрзЗржЦрзЗ, тАЬржУрж╣! Suspense ржЖржЫрзЗ ржХрж╛ржЫрзЗржЗ?тАЭ тАФ ржпржжрж┐ ржерж╛ржХрзЗ, рж╕рзЗржЯрж╛ **fallback** UI (ржпрзЗржоржи Loading spinner) ржжрзЗржЦрж╛рждрзЗ рж╢рзБрж░рзБ ржХрж░рзЗред **ржпрждржХрзНрж╖ржг ржирж╛ Promise рж░рзЗржЬрж▓ржн рж╣рзЯред**
3. Promise resolve рж╣рж▓рзЗржЗ **ржЖрж╕рж▓ ржХржорзНржкрзЛржирзЗржирзНржЯ (JSX) рж░рзЗржирзНржбрж╛рж░** рж╣рзЯред

## Implmentation Suspense (ржЪрж▓рзБржи ржмрж╛рж╕рзНрждржм ржЙржжрж╛рж╣рж░ржг ржжрзЗржЦрж┐)

### Option 1: `wrapPromise()` ржорзНржпрж╛ржирзБрзЯрж╛рж▓рж┐ рж▓рж┐ржЦрзЗ ржлрзЗрж▓рзЛ

React ржП `use()` рж╣рзБржХ ржЖрж╕рж╛рж░ ржЖржЧрзЗ Suspense ржмрзНржпржмрж╣рж╛рж░ ржХрж░рждрзЗ ржЪрж╛ржЗрж▓рзЗ ржЖржорж╛ржжрзЗрж░ `wrapperPromise` ржмрж╛ `resource.read()` ржзрж░ржирзЗрж░ ржорзНржпрж╛ржирзБрзЯрж╛рж▓ Promise handling utility рж▓рж┐ржЦрждрзЗ рж╣рждрзЛред ржПржЯрж╛ ржмрзЛржЭрж╛ржирзЛ ржжрж░ржХрж╛рж░, ржпрзЗржи ржкрж╛ржаржХ ржмрзБржЭрждрзЗ ржкрж╛рж░рзЗржи ржХрж┐ржнрж╛ржмрзЗ Suspense ржПрж░ ржзрж╛рж░ржгрж╛ ржПрж╕рзЗржЫрзЗ ржПржмржВ ржЖржЧрзЗржУ ржПржЯрж╛ ржХрж┐ржнрж╛ржмрзЗ ржХрж╛ржЬ ржХрж░рждред

**ржЖржЧрзЗ ржЖржорж░рж╛ `wrapPromise` ржирж┐рзЯрзЗ ржЖрж▓рзЛржЪржирж╛ ржХрж░ржм**, рждрж╛рж░ржкрж░ ржжрзЗржЦрж╛ржм ржХрж┐ржнрж╛ржмрзЗ `use()` ржПрж╕рзЗ рж╕ржм рж╕рж╣ржЬ ржХрж░рзЗ ржжрж┐рж▓рзЛред рж╕рзЗржЗрж╕рж╛ржерзЗ ржмрзЛржЭрж╛ржирзЛ рж╣ржмрзЗ ржПржЗ ржкрж░рж┐ржмрж░рзНрждржи ржХрзЗржи ржЧрзБрж░рзБрждрзНржмржкрзВрж░рзНржгред

---

ржзрж░рзБржи, ржЖржкржирж╛рж░ ржПржХржЯрж╛ ржХржорзНржкрзЛржирзЗржирзНржЯ ржЖржЫрзЗ, ржпрзЗржЯрж╛ API ржерзЗржХрзЗ ржбрзЗржЯрж╛ ржЖржиржмрзЗред ржЖржкржирж┐ ржЪрж╛ржи, ржпрждржХрзНрж╖ржг ржирж╛ ржбрзЗржЯрж╛ ржЖрж╕рзЗ, рждрждржХрзНрж╖ржг ржПржХржЯрж╛ тАЬтП│ LoadingтАжтАЭ ржжрзЗржЦрж╛ ржпрж╛ржмрзЗред

ржЖржЧрзЗ (ржорж╛ржирзЗ `<Suspense/>` ржЖрж╕рж╛рж░ ржЖржЧ ржкрж░рзНржпржирзНржд) ржЖржкржирж┐ ржХрзАржнрж╛ржмрзЗ ржХрж░рждрзЗржи?

#### тЪЩя╕П `useState` + `useEffect`

```jsx
const [albums, setAlbums] = useState(null);

useEffect(() => {
  fetch("/albums")
    .then((res) => res.json())
    .then((data) => setAlbums(data));
}, []);
```

ржПрж░ рж╕рж╛ржерзЗ ржПржХржЯрж╛ `isLoading`, ржПржХржЯрж╛ `error` state рж░рж╛ржЦрждрзЗ рж╣рждрзЛред ржПржЯрж╛ ржЫрзЛржЯ ржЕрзНржпрж╛ржкрзЗ ржЪрж▓ржд, ржХрж┐ржирзНрждрзБ ржЬржЯрж┐рж▓ ржЕрзНржпрж╛ржкрзЗ ржХрзЛржб рж╣рждрзЛ ржмрж┐рж╢рзНрж░рзАред

---

#### ЁЯФБ рждржЦржи React Suspense ржЖрж╕рж▓рзЛтАФ ржХрж┐ржирзНрждрзБ ржПржХржЯрж┐ рж╕ржорж╕рзНржпрж╛

React рждржЦржи ржмрж▓рж▓рзЛ:

> тАЬрждрзБржорж┐ ржЪрж╛ржЗрж▓рзЗ ржПржЦржи ржХржорзНржкрзЛржирзЗржирзНржЯржХрзЗ рж░рзЗржирзНржбрж╛рж░ рж╣рждрзЗ ржерж╛ржорж┐рзЯрзЗ ржжрж┐рждрзЗ ржкрж╛рж░рзЛ, ржпрждржХрзНрж╖ржг ржирж╛ ржбрзЗржЯрж╛ ржЖрж╕рзЗредтАЭ

---

```js
function wrapPromise(promise) {
  let status = "pending";
  let result;

  const suspender = promise.then(
    (res) => {
      status = "success";
      result = res;
    },
    (err) => {
      status = "error";
      result = err;
    }
  );

  return {
    read() {
      if (status === "pending") {
        throw suspender;
      } else if (status === "error") {
        throw result;
      } else {
        return result;
      }
    },
  };
}
```

#### ЁЯОп ржХрзЛржбрзЗ ржмрзНржпржмрж╣рж╛рж░ ржХрж░рж┐ ржПржЦржи

```js
// data.js
function fetchAlbums() {
  return fetch("/albums").then((res) => res.json());
}
const albumResource = wrapPromise(fetchAlbums());
```

```jsx
// Albums.js
function Albums() {
  const albums = albumResource.read(); // ржПржЦрж╛ржирзЗ Suspense ржХрж╛ржЬ ржХрж░рзЗ
  return (
    <ul>
      {albums.map((a) => (
        <li key={a.id}>{a.title}</li>
      ))}
    </ul>
  );
}
```

```jsx
<Suspense fallback={<Loading />}>
  ┬а <Albums />
</Suspense>
```

#### тЭЧ wrapperPromise() рж╕ржорж╕рзНржпрж╛ ржХрзА?

- `wrapPromise()` ржирж┐ржЬрзЗ рж▓рж┐ржЦрждрзЗ рж╣рждрзЛ
- ржХржирж╕рж┐рж╕рзНржЯрзЗржирзНржЯ error boundary рж╣рзНржпрж╛ржирзНржбрж▓рж┐ржВ ржХржарж┐ржи ржЫрж┐рж▓
- Boilerplate ржЕржирзЗржХ

ЁЯОп React 18 ржерзЗржХрзЗ ржПржЯрж╛ ржЕржирзЗржХ рж╕рж╣ржЬ рж╣рзЯрзЗржЫрзЗ ржХрж╛рж░ржг ржПржЦржи `use()` ржирж╛ржорзЗрж░ рж╣рзБржХ ржЖржЫрзЗред

---

### Option 2: `use()` рж╣рзБржХ ржмрзНржпржмрж╣рж╛рж░ ржХрж░рзЗ

#### рзз. Data fetch ржХрж░рж╛рж░ ржлрж╛ржВрж╢ржи

```js
// data.js
let cache = new Map();

export function fetchData(url) {
  if (!cache.has(url)) {
    cache.set(url, getData(url));
  }
  return cache.get(url);
}

async function getData(url) {
  await new Promise((resolve) => setTimeout(resolve, 2000)); // ржжрзЗрж░рж┐ ржХрж░рзЗ
  const response = await fetch(url);
  return await response.json();
}
```

---

#### рзи. Albums ржХржорзНржкрзЛржирзЗржирзНржЯ (Data fetch ржХрж░рзЗ)

```jsx
// Albums.js
import { use } from "react";
import { fetchData } from "./data.js";

export default function Albums() {
  const albums = use(fetchData("https://jsonplaceholder.typicode.com/albums"));
  return (
    <ul>
      {albums.slice(0, 5).map((album) => (
        <li key={album.id}>{album.title}</li>
      ))}
    </ul>
  );
}
```

тЪая╕П ржПржЦрж╛ржирзЗ ржХрж┐ржирзНрждрзБ `useEffect`, `useState` ржХрж┐ржЫрзБржЗ ржирж╛ржЗ! рж╢рзБржзрзБржЗ `use()` рж╣рзБржХ ржПржмржВ ржПржЯрж╛ ржирж┐ржЬрзЗ ржмрзБржЭрзЗ ржирж┐ржЪрзНржЫрзЗ ржХржЦржи fallback ржжрзЗржЦрж╛ржмрзЗред

---

#### рзй. App.js - Suspense ржмрзНржпржмрж╣рж╛рж░ ржХрж░рзЗ

```jsx
// App.js
import { Suspense } from "react";
import Albums from "./Albums.js";

function Loading() {
  return <h2>тП│ Loading Albums...</h2>;
}

export default function App() {
  return (
    <div>
      <h1>My Music App</h1>
      <Suspense fallback={<Loading />}>
        <Albums />
      </Suspense>
    </div>
  );
}
```

ЁЯза ржПржЦржи ржпржжрж┐ Albums ржлрзЗржЪрж┐ржВрзЯрзЗ рж╕ржорзЯ ржирзЗрзЯ, рждржЦржи `Loading` ржжрзЗржЦрж╛ржмрзЗ, ржЖрж░ ржбрзЗржЯрж╛ ржЪрж▓рзЗ ржЖрж╕рж▓рзЗ `Albums` рж░рзЗржирзНржбрж╛рж░ рж╣ржмрзЗред

---

### тЫУя╕П ржпржжрж┐ ржХрж┐ржЫрзБ Error рж╣рзЯ?

React Suspense ржирж┐ржЬрзЗ ржерзЗржХрзЗ ржПрж░рж░ рж╣рзНржпрж╛ржирзНржбрзЗрж▓ ржХрж░рждрзЗ ржкрж╛рж░рзЗ ржирж╛ред ржПржЬржирзНржп ржжрж░ржХрж╛рж░ `ErrorBoundary`ред ржПржЗржЬржирзНржп ржЖржорж░рж╛ ржПржХржЯрж╛ `ErrorBoundary` npm ржмрзНржпржмрж╣рж╛рж░ ржХрж░рждрзЗ ржкрж╛рж░рж┐, ржпрж╛ Suspense ржПрж░рж░ рж╣рзНржпрж╛ржирзНржбрзЗрж▓ ржХрж░ржмрзЗред ржЪрж╛ржЗрж▓рзЗ ржирж┐ржЪрзЗрж░ ржХрзЛржбржЯрж┐ржУ ржмрзНржпржмрж╣рж╛рж░ ржХрж░рждрзЗ ржкрж╛рж░рж┐,

```js
// ErrorBoundary.js
import React from "react";

class ErrorBoundary extends React.Component {
  constructor(props) {
    super(props);
    this.state = { hasError: false, error: null };
  }

  static getDerivedStateFromError(error) {
    return { hasError: true, error };
  }

  render() {
    if (this.state.hasError) {
      return <h2>тЭМ {this.state.error.message}</h2>;
    }
    return this.props.children;
  }
}

export default ErrorBoundary;
```

ржПржЦржи `App.js` ржП рж░тАНрзНржпрж╛ржк ржХрж░рзБржи:

```jsx
import ErrorBoundary from "./ErrorBoundary.js";

<ErrorBoundary>
  <Suspense fallback={<Loading />}>
    <Albums />
  </Suspense>
</ErrorBoundary>;
```

---

## ЁЯзм Nested Suspense тАУ Step by Step Loading

React-ржП ржЖржкржирж┐ ржЪрж╛ржЗрж▓рзЗ **ржПржХржЯрж╛ ржмрзЬ UI ржХрзЗ ржзрж╛ржкрзЗ ржзрж╛ржкрзЗ рж▓рзЛржб** ржХрж░рждрзЗ ржкрж╛рж░рзЗржиред

```jsx
<Suspense fallback={<BigSpinner />}>
  <Biography />
  <Suspense fallback={<AlbumsGlimmer />}>
    <Albums />
  </Suspense>
</Suspense>
```

ЁЯМА ржПржЯрж╛ ржХрзАржнрж╛ржмрзЗ ржХрж╛ржЬ ржХрж░рзЗ?

1. Biography ржирж╛ ржЖрж╕рж╛ ржкрж░рзНржпржирзНржд тЖТ BigSpinner ржжрзЗржЦрж╛ржмрзЗ
2. Biography ржЪрж▓рзЗ ржПрж▓рзЗ тЖТ Biography ржжрзЗржЦрж╛ржмрзЗ
3. Albums ржПржЦржирзЛ ржирж╛ ржПрж▓рзЗ тЖТ AlbumsGlimmer ржжрзЗржЦрж╛ржмрзЗ
4. Albums ржЖрж╕рж▓рзЗ тЖТ ржкрзБрж░рж╛ UI ready

---

## ЁЯз╝ рж╕рж╛рж░рж╛ржВрж╢ тАУ ржХрзА рж╢рж┐ржЦрж▓рж╛ржо?

| рж╢рж┐ржЦрзЗржЫрж┐                      | ржЕрж░рзНрже                                          |
| --------------------------- | --------------------------------------------- |
| `<Suspense fallback={...}>` | рж▓рзЛржбрж┐ржВ UI ржжрзЗржЦрж╛рждрзЗ рж╕рж╛рж╣рж╛ржпрзНржп ржХрж░рзЗ                   |
| `use()`                     | ржбрзЗржЯрж╛ рж▓рзЛржб рж╣рзЯрзЗ ржЧрзЗрж▓рзЗ рж░рж┐ржЯрж╛рж░рзНржи, ржирж╛ рж╣рж▓рзЗ suspend ржХрж░рзЗ |
| Nested Suspense             | UI ржзрж╛ржкрзЗ ржзрж╛ржкрзЗ ржжрзЗржЦрж╛ржирзЛ ржпрж╛рзЯ                       |
| ErrorBoundary               | ржПрж░рж░ ржзрж░рждрзЗ рж▓рж╛ржЧрзЗ                                 |
| `startTransition`           | UI ржЯрзНрж░рж╛ржиржЬрж┐рж╢ржи рж╕рзНржорзБрже рж░рж╛ржЦрзЗ                       |

---

## ЁЯОБ Bonus Tip

React Suspense ржПржЦржирзЛ evolving, рждрж╛ржЗ рж╕ржм ржбрзЗржЯрж╛ ржлрзЗржЪрж┐ржВ рж▓рж╛ржЗржмрзНрж░рзЗрж░рж┐ (ржпрзЗржоржи Axios) рж╕рж░рж╛рж╕рж░рж┐ рж╕рж╛ржкрзЛрж░рзНржЯ ржХрж░рзЗ ржирж╛ред рждржмрзЗ Next.js ржмрж╛ Relay ржПрж░ ржорждрзЛ ржлрзНрж░рзЗржоржУрзЯрж╛рж░рзНржХрзЗ Suspense ржЦрзБржм ржнрж╛рж▓рзЛ ржХрж╛ржЬ ржХрж░рзЗред

---
